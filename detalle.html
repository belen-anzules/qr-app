<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Detalle del Plato - Macro Fit</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

<header class="header-clean">
    <a id="btn-volver" class="back" style="text-decoration:none; font-size:24px;">â€¹</a>
    <h2 id="plato-nombre">Cargando...</h2>
    <div class="cart-icon" id="btn-cart" style="font-size:22px; cursor:pointer;">ðŸ§¾</div>
</header>

<main class="detail-container">
    <div class="detail-img-header">
        <img id="plato-img" src="" alt="Plato" style="width:100%; height:300px; object-fit:cover;">
    </div>

    <section class="detail-content" style="padding: 20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 id="plato-titulo-sec" style="font-size:1.4rem; color:#2D3436;">Personaliza tu plato</h3>
            <span class="price-tag" style="font-size:1.1rem; color:#2E7D32; font-weight:bold;">$<span id="base-price-display">0.00</span></span>
        </div>

        <p id="plato-descripcion" style="color:#666; font-size:0.95rem; margin-bottom:20px; line-height:1.4;"></p>

        <h4 style="margin-bottom:15px; color:#333;">Extras Sugeridos:</h4>

        <div class="ingredient-item" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; background:#f9f9f9; padding:10px; border-radius:10px;">
            <div class="ing-info">
                <span class="ing-name" style="font-weight:600;">Aguacate Extra</span>
                <span class="ing-price" style="display:block; font-size:0.8rem; color:#888;">+$1.00</span>
            </div>
            <div class="controls">
                <button class="btn-qty" onclick="changeQty('aguacate', -1)">âˆ’</button>
                <span id="aguacate-qty" style="margin:0 10px; font-weight:bold;">0</span>
                <button class="btn-qty" onclick="changeQty('aguacate', 1)">+</button>
            </div>
        </div>

        <div class="ingredient-item" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; background:#f9f9f9; padding:10px; border-radius:10px;">
            <div class="ing-info">
                <span class="ing-name" style="font-weight:600;">ProteÃ­na Extra</span>
                <span class="ing-price" style="display:block; font-size:0.8rem; color:#888;">+$2.00</span>
            </div>
            <div class="controls">
                <button class="btn-qty" onclick="changeQty('proteina', -1)">âˆ’</button>
                <span id="proteina-qty" style="margin:0 10px; font-weight:bold;">0</span>
                <button class="btn-qty" onclick="changeQty('proteina', 1)">+</button>
            </div>
        </div>

        <div style="height: 120px;"></div>
    </section>
</main>

<div class="cart-footer" style="position:fixed; bottom:0; width:100%; background:white; padding:20px; box-shadow:0 -5px 15px rgba(0,0,0,0.05); box-sizing:border-box;">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-weight:bold; font-size:1.1rem;">
        <span>Total:</span>
        <span style="color:#2E7D32;">$<span id="total-price">0.00</span></span>
    </div>
    <button class="btn btn-primary" onclick="confirmarPedido()" style="width:100%; padding:15px; background:#2E7D32; color:white; border:none; border-radius:12px; font-weight:bold; font-size:1rem;">AÃ±adir al Carrito âœ…</button>
</div>

<script>
    let currentBasePrice = 0;
    let extras = { aguacate: 0, proteina: 0 };
    const extraPrices = { aguacate: 1.00, proteina: 2.00 };
    let editIndex = null;

    window.onload = () => {
        const params = new URLSearchParams(window.location.search);
        const cartString = params.get('cart') || "";

        // 1. Configurar botones de navegaciÃ³n para no perder el carrito
        document.getElementById('btn-volver').href = `menu.html?cart=${cartString}`;
        document.getElementById('btn-cart').onclick = () => location.href = `pedido.html?cart=${cartString}`;

        // 2. Cargar datos bÃ¡sicos del plato desde la URL
        const nombre = params.get('p_nombre') || "Plato Saludable";
        currentBasePrice = parseFloat(params.get('p_precio')) || 0.00;
        const imagen = params.get('p_img') || "https://images.unsplash.com/photo-1546069901-ba9599a7e63c";
        const descripcion = params.get('p_desc') || "Deliciosa opciÃ³n saludable preparada con ingredientes frescos.";

        document.getElementById('plato-nombre').innerText = nombre;
        document.getElementById('plato-titulo-sec').innerText = nombre;
        document.getElementById('plato-img').src = imagen;
        document.getElementById('plato-descripcion').innerText = descripcion;
        document.getElementById('base-price-display').innerText = currentBasePrice.toFixed(2);

        // 3. LÃ³gica de EDICIÃ“N: Si viene de pedido.html, cargar valores previos
        if (params.has('editIndex')) {
            editIndex = params.get('editIndex');
            if(params.has('aguacate')) extras.aguacate = parseInt(params.get('aguacate'));
            if(params.has('proteina')) extras.proteina = parseInt(params.get('proteina'));
            
            document.getElementById('aguacate-qty').innerText = extras.aguacate;
            document.getElementById('proteina-qty').innerText = extras.proteina;
        }
        
        updateTotal();
    };

    function changeQty(ing, val) {
        if (extras[ing] + val >= 0) {
            extras[ing] += val;
            document.getElementById(`${ing}-qty`).innerText = extras[ing];
            updateTotal();
        }
    }

    function updateTotal() {
        let total = currentBasePrice;
        for (let key in extras) {
            total += extras[key] * extraPrices[key];
        }
        document.getElementById('total-price').innerText = total.toFixed(2);
    }

    function confirmarPedido() {
        const params = new URLSearchParams(window.location.search);
        // Obtener el carrito actual de la URL
        let cart = params.get('cart') ? JSON.parse(decodeURIComponent(params.get('cart'))) : [];

        // Crear descripciÃ³n de extras para el resumen
        let detArray = [];
        if(extras.aguacate > 0) detArray.push(`${extras.aguacate}x Aguacate`);
        if(extras.proteina > 0) detArray.push(`${extras.proteina}x ProteÃ­na`);

        const item = {
            nombre: document.getElementById('plato-nombre').innerText,
            total: document.getElementById('total-price').innerText,
            page: "detalle.html", // Referencia para editar
            extras: detArray.join(", ") || "Sin extras",
            config: { 
                aguacate: extras.aguacate, 
                proteina: extras.proteina,
                p_nombre: document.getElementById('plato-nombre').innerText,
                p_precio: currentBasePrice,
                p_img: document.getElementById('plato-img').src,
                p_desc: document.getElementById('plato-descripcion').innerText
            }
        };

        // Si estamos editando, reemplazamos. Si no, aÃ±adimos.
        if (editIndex !== null) {
            cart[editIndex] = item;
        } else {
            cart.push(item);
        }

        // Enviar de vuelta a pedido.html con el carrito actualizado en la URL
        const cartString = encodeURIComponent(JSON.stringify(cart));
        window.location.href = `pedido.html?cart=${cartString}`;
    }
</script>
</body>
</html>