<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Resumen - Macro Fit</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

<header class="header-clean">
    <a id="link-back-menu" class="back" style="text-decoration:none; font-size: 24px;">‚Äπ</a>
    <h2 style="letter-spacing: 1px;">RESUMEN</h2>
    <div style="width:40px;"></div>
</header>

<main class="menu" style="padding: 20px;">
    <div id="pedido-lista"></div>

    <div id="resumen-pago" style="margin-top: 30px; padding: 20px; background: #f9f9f9; border-radius: 20px; display: none;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; color: #666;">
            <span>Subtotal</span>
            <span id="subtotal">$0.00</span>
        </div>
        <div style="display: flex; justify-content: space-between; font-weight: 900; font-size: 1.4rem; color: #2D3436; border-top: 1px dashed #ddd; padding-top: 15px; margin-top: 10px;">
            <span>TOTAL</span>
            <span id="total-global" style="color: #4CAF50;">$0.00</span>
        </div>
    </div>

    <div style="height: 180px;"></div>
</main>

<div class="cart-footer">
    <button class="btn btn-secondary" id="btn-add-more" style="border: 2px solid #4CAF50;">+ A√±adir otro plato</button>
    <button class="btn btn-primary" onclick="finalizarCompra()">Confirmar Pedido</button>
</div>

<div id="modalConfirmacion" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;">
    <div class="modal-card" style="background:white; padding:30px; border-radius:30px; text-align:center; width:80%;">
        <div style="font-size: 50px; margin-bottom: 15px;">ü•ó</div>
        <h2 style="color: #2D3436;">¬°Buen provecho!</h2>
        <p style="color: #666; margin-bottom: 20px;">Tu pedido ha sido enviado. Paga en caja con este c√≥digo:</p>
        <div style="background:#f0f0f0; padding:15px; border-radius:15px;">
            <p style="font-size: 0.7rem; color: #888; margin-bottom: 5px; font-weight: bold;">C√ìDIGO DE PEDIDO</p>
            <div id="codigoPedido" style="font-size:2rem; font-weight:900; color:#4CAF50;"></div>
        </div>
        <button class="btn btn-primary" onclick="limpiarYSalir()" style="margin-top:20px; width:100%;">Finalizar</button>
    </div>
</div>

<script>
    function getCart() {
        const params = new URLSearchParams(window.location.search);
        // Priorizamos la URL para que la edici√≥n funcione, si no hay nada, devolvemos vac√≠o
        return params.get('cart') ? JSON.parse(decodeURIComponent(params.get('cart'))) : [];
    }

    function mostrarPedido() {
        const cart = getCart();
        const container = document.getElementById('pedido-lista');
        const resumen = document.getElementById('resumen-pago');
        const cartString = encodeURIComponent(JSON.stringify(cart));
        
        // Mantener el carrito al volver al men√∫
        document.getElementById('link-back-menu').href = `menu.html?cart=${cartString}`;
        document.getElementById('btn-add-more').onclick = () => location.href = `menu.html?cart=${cartString}`;

        if(cart.length === 0) {
            container.innerHTML = `<div style="text-align:center; padding:60px 20px;"><p>Tu carrito est√° vac√≠o</p></div>`;
            resumen.style.display = "none";
            return;
        }

        resumen.style.display = "block";
        container.innerHTML = "";
        let sumaTotal = 0;

        cart.forEach((item, index) => {
            sumaTotal += parseFloat(item.total);
            
            // CONSTRUIR URL DE EDICI√ìN:
            // Regresamos a la p√°gina original del plato (item.page)
            let configParams = "";
            for(let key in item.config) {
                configParams += `&${key}=${item.config[key]}`;
            }
            const urlEditar = `${item.page}?cart=${cartString}&editIndex=${index}${configParams}`;

            container.innerHTML += `
                <div class="card" style="padding:15px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center; border-radius:20px; background:white; box-shadow:0 4px 10px rgba(0,0,0,0.05);">
                    <div style="flex:1;">
                        <strong style="font-size:1.1rem; color:#333;">${item.nombre}</strong>
                        <p style="font-size:0.8rem; color:#888; margin:4px 0;">${item.extras}</p>
                        <span style="color:#4CAF50; font-weight:bold;">$${item.total}</span>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button onclick="location.href='${urlEditar}'" style="border:none; background:#E8F5E9; color:#4CAF50; padding:10px; border-radius:12px; cursor:pointer;">‚úèÔ∏è</button>
                        <button onclick="eliminar(${index})" style="border:none; background:#FFEBEE; color:#F44336; padding:10px; border-radius:12px; cursor:pointer;">üóëÔ∏è</button>
                    </div>
                </div>`;
        });

        document.getElementById('subtotal').innerText = `$${sumaTotal.toFixed(2)}`;
        document.getElementById('total-global').innerText = `$${sumaTotal.toFixed(2)}`;
    }

    function eliminar(index) {
        let cart = getCart();
        cart.splice(index, 1);
        location.href = `pedido.html?cart=${encodeURIComponent(JSON.stringify(cart))}`;
    }

    function finalizarCompra() {
        const codigo = Math.floor(100000 + Math.random() * 900000);
        document.getElementById("codigoPedido").innerText = codigo;
        document.getElementById("modalConfirmacion").style.display = "flex";
    }

    function limpiarYSalir() {
        window.location.href = 'menu.html';
    }

    window.onload = mostrarPedido;
</script>
</body>
</html>