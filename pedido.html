<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Resumen - Macro Fit</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

<header class="header-clean">
    <a id="link-back-menu" class="back" style="text-decoration:none; font-size: 24px;">‚Äπ</a>
    <h2 style="letter-spacing: 1px;">RESUMEN</h2>
    <div style="width:40px;"></div>
</header>

<main class="menu" style="padding: 20px;">
    <div id="pedido-lista"></div>

    <div id="resumen-pago" style="margin-top: 30px; padding: 20px; background: #f9f9f9; border-radius: 20px; display: none;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; color: #666;">
            <span>Subtotal</span>
            <span id="subtotal">$0.00</span>
        </div>
        <div style="display: flex; justify-content: space-between; font-weight: 900; font-size: 1.4rem; color: #2D3436; border-top: 1px dashed #ddd; pt: 15px; margin-top: 10px;">
            <span>TOTAL</span>
            <span id="total-global" style="color: #4CAF50;">$0.00</span>
        </div>
    </div>

    <div style="height: 180px;"></div>
</main>

<div class="cart-footer">
    <button class="btn btn-secondary" id="btn-add-more" style="border: 2px solid #4CAF50;">+ A√±adir otro plato</button>
    <button class="btn btn-primary" onclick="finalizarCompra()">Confirmar Pedido</button>
</div>

<div id="modalConfirmacion" class="modal">
    <div class="modal-card">
        <div style="font-size: 50px; margin-bottom: 15px;">ü•ó</div>
        <h2 style="color: #2D3436;">¬°Buen provecho!</h2>
        <p style="color: #666; margin-bottom: 20px;">Tu pedido ha sido enviado a cocina. Paga con este c√≥digo:</p>
        
        <div class="codigo-contenedor">
            <p style="font-size: 0.7rem; color: #888; margin-bottom: 5px; font-weight: bold;">C√ìDIGO DE CAJA</p>
            <div id="codigoPedido" class="codigo"></div>
        </div>
        
        <button class="btn btn-primary" onclick="limpiarYSalir()">Finalizar</button>
    </div>
</div>

<script>
    function getCart() {
        const params = new URLSearchParams(window.location.search);
        return params.get('cart') ? JSON.parse(decodeURIComponent(params.get('cart'))) : [];
    }

    function mostrarPedido() {
        const cart = getCart();
        const container = document.getElementById('pedido-lista');
        const resumen = document.getElementById('resumen-pago');
        const cartString = encodeURIComponent(JSON.stringify(cart));
        
        // Mantener navegaci√≥n sin perder carrito
        document.getElementById('link-back-menu').href = `menu.html?cart=${cartString}`;
        document.getElementById('btn-add-more').onclick = () => location.href = `menu.html?cart=${cartString}`;

        if(cart.length === 0) {
            container.innerHTML = `
                <div style="text-align:center; padding:60px 20px;">
                    <div style="font-size:60px; margin-bottom:20px;">ü•£</div>
                    <p style="color:#999; font-weight:600;">Tu carrito est√° vac√≠o</p>
                    <a href="menu.html" class="btn btn-primary" style="display:inline-block; margin-top:20px; text-decoration:none;">Ver Men√∫</a>
                </div>`;
            resumen.style.display = "none";
            return;
        }

        resumen.style.display = "block";
        container.innerHTML = "";
        let sumaTotal = 0;

        cart.forEach((item, index) => {
            sumaTotal += parseFloat(item.total);
            
            // L√≥gica de edici√≥n: pasar nombre, precio base e imagen original si fuera necesario
            let configParams = "";
            for(let key in item.config) configParams += `&${key}=${item.config[key]}`;
            // A√±adimos p_nombre y p_precio para que detalle.html cargue correctamente los datos del plato
            const urlEditar = `detalle.html?cart=${cartString}&editIndex=${index}&p_nombre=${encodeURIComponent(item.nombre)}&p_precio=7.99${configParams}`;

            container.innerHTML += `
                <div class="card" style="padding:15px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center; border-radius:20px;">
                    <div style="flex:1;">
                        <strong style="font-size:1.1rem; color:#333;">${item.nombre}</strong>
                        <p style="font-size:0.8rem; color:#888; margin:4px 0;">${item.extras}</p>
                        <span style="color:#4CAF50; font-weight:bold;">$${item.total}</span>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-qty" onclick="location.href='${urlEditar}'" style="background:#E8F5E9; color:#4CAF50;">‚úèÔ∏è</button>
                        <button class="btn-qty" onclick="eliminar(${index})" style="background:#FFEBEE; color:#F44336;">üóëÔ∏è</button>
                    </div>
                </div>`;
        });

        document.getElementById('subtotal').innerText = `$${sumaTotal.toFixed(2)}`;
        document.getElementById('total-global').innerText = `$${sumaTotal.toFixed(2)}`;
    }

    function eliminar(index) {
        let cart = getCart();
        cart.splice(index, 1);
        location.href = `pedido.html?cart=${encodeURIComponent(JSON.stringify(cart))}`;
    }

    function finalizarCompra() {
        const codigo = Math.floor(100000 + Math.random() * 900000);
        document.getElementById("codigoPedido").innerText = codigo;
        document.getElementById("modalConfirmacion").style.display = "flex";
    }

    function limpiarYSalir() {
        // Al finalizar, borramos carrito y volvemos al men√∫ limpio
        window.location.href = 'menu.html';
    }

    window.onload = mostrarPedido;
</script>
</body>
</html>