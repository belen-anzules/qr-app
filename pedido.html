<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Resumen del Pedido</title>
<style>
:root {
    --primary: #4CAF50;
    --secondary: #f8f9fa;
    --accent: #FF9800;
    --dark: #2c3e50;
}

body {
    font-family: 'Segoe UI', sans-serif;
    margin: 0;
    background: #f4f7f6;
    color: var(--dark);
    padding-bottom: 120px;
}

.cart-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #fff;
    padding: 15px;
    margin: 12px 20px;
    border-radius: 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,.05);
}

.cart-info { flex: 1; }
.extras-small { font-size: 0.8rem; color: #888; margin: 4px 0; }
.price-tag { color: var(--primary); font-weight: 800; }

.cart-actions { display: flex; gap: 8px; }
.action-btn {
    border: none;
    background: #f0f2f5;
    padding: 10px;
    border-radius: 12px;
    cursor: pointer;
}

.cart-footer {
    position: fixed;
    bottom: 0;
    width: 100%;
    background: white;
    padding: 20px;
    display: flex;
    gap: 10px;
    box-sizing: border-box;
    border-radius: 25px 25px 0 0;
    box-shadow: 0 -10px 20px rgba(0,0,0,0.05);
    z-index: 900;
}

.btn {
    flex: 1;
    border: none;
    padding: 16px;
    border-radius: 15px;
    font-weight: bold;
    cursor: pointer;
}

.btn-primary { background: var(--primary); color: white; }
.btn-secondary { background: var(--secondary); color: var(--dark); border: 1px solid #ddd; }

.modal-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    backdrop-filter: blur(5px);
}

.modal-card {
    background: white;
    padding: 30px;
    border-radius: 25px;
    width: 85%;
    max-width: 380px;
    text-align: center;
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}

.modal-card input {
    width: 100%;
    padding: 14px;
    margin: 8px 0;
    border: 1px solid #eee;
    border-radius: 12px;
    box-sizing: border-box;
}
</style>
</head>

<body>

<header style="padding: 20px; text-align: center; background: white; position: relative;">
    <button onclick="irAMenu()" style="
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        background:none;
        border:none;
        font-size:1.5rem;
        cursor:pointer;
    ">‚¨ÖÔ∏è</button>
    <h2 style="margin:0; font-weight: 900;">MI PEDIDO</h2>
</header>


<div id="pedido-lista"></div>

<div id="total-box" style="display:none; text-align:right; padding:20px; margin-bottom: 20px;">
    <span style="color: #888;">Total a pagar</span><br>
    <span style="font-size: 2rem; font-weight: 900;">
        $<span id="total-global">0.00</span>
    </span>
</div>

<div class="cart-footer">
    <button class="btn btn-secondary" onclick="irAMenu()">+ A√±adir</button>
    <button class="btn btn-primary" onclick="validarYConfirmar()">Confirmar</button>
</div>

<!-- MODAL REGISTRO AMIGABLE -->
<div id="modal-registro" class="modal-overlay">
    <div class="modal-card">
        <div style="font-size:50px; margin-bottom:10px;">üìù</div>
        <h2 style="color:#4CAF50; margin-bottom:5px;">Datos del Cliente</h2>
        <p style="font-size:0.9rem; color:#555; margin-bottom:20px;">
            Ingresa tus datos para generar tu ticket de compra.
        </p>
        
        <div style="text-align: left; margin-bottom: 15px;">
            <label style="font-size: 0.8rem; color: #888; margin-left: 5px;">Nombre Completo</label>
            <input type="text" id="nombre" placeholder="Ej. Mateo Delgado" required>
        </div>

        <div style="text-align: left; margin-bottom: 15px;">
            <label style="font-size: 0.8rem; color: #888; margin-left: 5px;">C√©dula / ID</label>
            <input type="number" id="cedula" placeholder="Ej. 1712345678" required>
        </div>

        <div style="text-align: left; margin-bottom: 15px;">
            <label style="font-size: 0.8rem; color: #888; margin-left: 5px;">Tel√©fono Celular</label>
            <input type="tel" id="telefono" placeholder="Ej. 0991234567" required>
        </div>

        <div style="text-align: left; margin-bottom: 15px;">
    <label style="font-size: 0.8rem; color: #888; margin-left: 5px;">Direcci√≥n de Entrega</label>
    <input type="text" id="direccion" placeholder="Ej. Av. Amazonas y Rio Coca" required>
</div>

        <button class="btn btn-primary" 
                style="width:100%; margin-top:10px; padding: 18px; font-size: 1rem;" 
                onclick="procesarFinalizado()">
            GENERAR TICKET üöÄ
        </button>
        
        <button style="margin-top:15px; background:none; border:none; color:#aaa; cursor:pointer; font-size: 0.9rem;" 
                onclick="cerrarModales()">
            Cancelar y volver
        </button>
    </div>
</div>

<style>
    .modal-card input {
        width: 100%;
        padding: 12px;
        margin-top: 5px;
        border: 1.5px solid #eee;
        border-radius: 12px;
        box-sizing: border-box;
        font-size: 1rem;
        outline: none;
        transition: 0.3s;
    }
    .modal-card input:focus {
        border-color: #4CAF50;
        background-color: #f9fff9;
    }
    /* Quitar flechas del input number */
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
</style>

<!-- MODAL VAC√çO -->
<div id="modal-vacio" class="modal-overlay">
    <div class="modal-card modal-vacio-estilo">
        <div class="icon-container">
            <span class="pulse-icon">ü•ò</span>
        </div>
        <h2>¬°Tu carrito te espera!</h2>
        <p>Parece que a√∫n no has elegido tu combinaci√≥n perfecta de hoy. ¬°Nuestra cocina est√° lista para empezar!</p>
        
        <button class="btn btn-primary btn-explorar" onclick="irAMenu()">
            Explorar el Men√∫ üòã
        </button>
        
        <p class="sub-text" onclick="cerrarModales()">Seguir mirando</p>
    </div>
</div>
<!-- ...todo tu HTML arriba se mantiene igual... -->

<script>
const pedidoDiv = document.getElementById("pedido-lista");

function getCartFromURL() {
    const params = new URLSearchParams(window.location.search);
    const cartData = params.get('cart');
    return cartData ? JSON.parse(decodeURIComponent(cartData)) : [];
}

function mostrarPedido() {
    const cart = getCartFromURL();
    const totalBox = document.getElementById("total-box");
    const totalSpan = document.getElementById("total-global");

    if (cart.length === 0) {
        pedidoDiv.innerHTML = `<div style="text-align:center; padding:50px; color:#ccc;">üõí Tu lista est√° vac√≠a</div>`;
        totalBox.style.display = "none";
        return;
    }

    pedidoDiv.innerHTML = "";
    let totalGlobal = 0;

    cart.forEach((item, index) => {
        totalGlobal += parseFloat(item.total);

        let configParams = "";
        if (item.config) {
            for (let key in item.config) {
                configParams += `&${key}=${item.config[key]}`;
            }
        }

        const cartString = encodeURIComponent(JSON.stringify(cart));
        const urlEditar = `${item.page}?cart=${cartString}&editIndex=${index}${configParams}`;

        pedidoDiv.innerHTML += `
            <div class="cart-item">
                <div class="cart-info">
                    <strong>${item.nombre}</strong>
                    <p class="extras-small">${item.extras || 'Sin cambios'}</p>
                    <span class="price-tag">$${parseFloat(item.total).toFixed(2)}</span>
                </div>
                <div class="cart-actions">
                    <button class="action-btn" onclick="location.href='${urlEditar}'">‚úèÔ∏è</button>
                    <button class="action-btn" onclick="eliminarPlato(${index})">üóëÔ∏è</button>
                </div>
            </div>
        `;
    });

    totalSpan.innerText = totalGlobal.toFixed(2);
    totalBox.style.display = "block";

    // üîπ NUEVA FUNCIONALIDAD: Guardar autom√°ticamente el carrito en localStorage
    localStorage.setItem("carritoMacroFit", JSON.stringify(cart));
}

// Validar carrito y abrir modal correspondiente
function validarYConfirmar() {
    const cart = getCartFromURL();
    if (cart.length === 0) {
        document.getElementById("modal-vacio").style.display = "flex";
    } else {
        document.getElementById("modal-registro").style.display = "flex";
    }
}

function cerrarModales() {
    document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
}function procesarFinalizado() {
    const nombreInput = document.getElementById("nombre");
    const cedulaInput = document.getElementById("cedula");
    const telefonoInput = document.getElementById("telefono");
    const direccionInput = document.getElementById("direccion"); // Nueva referencia

    if (!nombreInput || !cedulaInput || !telefonoInput || !direccionInput) return;

    const nom = nombreInput.value.trim();
    const ci = cedulaInput.value.trim();
    const tel = telefonoInput.value.trim();
    const dir = direccionInput.value.trim(); // Nuevo valor

    if (!nom || !ci || !tel || !dir) {
        alert("‚ö†Ô∏è Completa todos los campos, incluyendo la direcci√≥n");
        return;
    }

    const ahora = new Date();
    const datosTicket = {
        codigo: "MF-" + Math.floor(100000 + Math.random() * 900000),
        cliente: nom,
        cedula: ci,
        telefono: tel,
        direccion: dir, // Incluido en el objeto
        fecha: ahora.toLocaleDateString('es-ES'),
        hora: ahora.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
    };

    // Guardado limpio y seguro
    try {
        localStorage.setItem("ticketAPK", JSON.stringify(datosTicket));
        localStorage.setItem("ticketAPK_BACKUP", JSON.stringify(datosTicket));
        
        console.log("Guardado exitoso con direcci√≥n. Redirigiendo...");

        setTimeout(() => {
            window.location.href = "ver-ticket.html";
        }, 150);
    } catch (e) {
        console.error("Error al guardar:", e);
    }
}
function eliminarPlato(index) {
    let cart = getCartFromURL();
    cart.splice(index, 1);
    window.location.href = `pedido.html?cart=${encodeURIComponent(JSON.stringify(cart))}`;
}

function irAMenu() {
    const cart = getCartFromURL();
    window.location.href = `menu.html?cart=${encodeURIComponent(JSON.stringify(cart))}`;
}

window.onload = mostrarPedido;
</script>
</body>
</html>